# 第六章 逻辑时钟-水位线

**两种时间语义**

![image-20230213183755356](https://cos.gump.cloud/uPic/image-20230213183755356.png)

- 处理时间：事件进入 process 算子的机器时间。调用 `ctx.timerService().currentProcessingTime()` 时的机器时间。
- 事件时间：事件中包含的时间戳，事件真实发生的时间。

举两个例子：

![31](https://cos.gump.cloud/uPic/31.svg)

![34](https://cos.gump.cloud/uPic/34.svg)

{==由于事件时间的世界里面没有时钟机制==}，所以我们需要为事件时间的世界提供时钟机制，叫做{==水位线（逻辑时钟）==}。

时钟的定义：{==单调递增==}的序列。

如果单调递增的序列是 CPU 产生的，那么就是物理时钟。如果是编程产生的，那么就是逻辑时钟。

水位线流动到哪一个算子，哪一个算子就会更新自己的时钟（产线工人的手表）。水位线不会弯道超车，也就是说，水位线不会绕过水位线前面的数据传播下去。如果某个算子的计算过程很耗时，那么会阻塞水位线的向下传播。如果上游的算子阻塞了水位线的传播，那么上游算子和下游算子的水位线（时钟）可能是不一样的。

在使用处理时间（ ProcessingTime ）的情况下，不存在乱序数据的情况。

乱序数据只存在于使用事件时间的情况下。

时钟：

- 物理时钟：机器时间，墙上时钟
- 逻辑时钟：水位线
  在Flink里面，时钟的作用是什么？
- 触发定时器
- 关闭窗口

## 有关水位线的一些约定

1. 水位线是事件时间的世界中的逻辑时钟。
2. 水位线是一种{==特殊的事件==}，水位线是一条特殊的数据。由程序员编程（调用 `assignTimestampsAndWatermarks` 向下游发送一条水位线事件）插入到数据流中。随数据流流动。水位线事件和数据流中的数据是完全没关系的。水位线是 `Watermark` 类型。数据是 String、POJO Class 等等类型。
3. 算子的每个并行子任务会维护自己的水位线（逻辑时钟），当接收到上游发送过来的水位线时，更新自己的水位线（逻辑时钟）。
4. 水位线 = 观察到的最大事件时间戳 - 最大延迟时间 - 1 毫秒
   - 最大延迟时间需要程序员根据经验自己设置
     - 设置的越大，迟到数据越少，计算的越准确，但是得到结果的延迟越高。
     - 设置的越小，迟到数据越多，计算的越不准确，但是得到结果的延迟越低。
5. Flink 会在{==流的最开始==}插入一个时间戳为负无穷大（ `Long.MIN_VALUE` ）的水位线。
6. Flink 会在{==流的最末尾==}插入一个时间戳为正无穷大（ `Long.MAX_VALUE` ）的水位线。为了将所有注册的定时器和窗口都触发执行。
7. ProcessWindowFunction 的并行子任务的水位线 >= 事件时间窗口的结束时间 - 1毫秒，触发窗口计算。
8. KeyedProcessFunction 的并行子任务的水位线 >= 事件时间定时器的时间戳，触发定时器执行。

## 多流转换时水位线的传播机制

![32](https://cos.gump.cloud/uPic/32.svg)

- 分流：水位线复制然后广播到下游的所有并行子任务中去。
- 合流：

第一步：到达的水位线覆盖数组中对应的水位线。

第二步：选择水位线数组中的最小的水位线来更新并行子任务的水位线。

## 水位线设置的最佳实践

- 在尽量靠近数据源的地方插入水位线（ `assignTimestampsAndWatermarks` ）。
- `assignTimestampsAndWatermarks` 前面的算子的并行度最好是 `1`。

### Kafka水位线设置

数据源（ `FlinkKafkaConsumer` ）的并行度（小于）等于 Kafka 主题的分区数量。

插入水位线之前的所有算子的并行度和 Kafka 主题的分区数量一致。

## 如何处理迟到数据

到达的数据的事件时间小于当前算子的并行子任务的水位线，就是迟到数据。{==只有在使用事件时间的情况下，才会存在迟到元素==}。对于处理时间来说，不存在迟到数据。

处理迟到数据的策略：

- 默认策略（ ProcessWindowFunction ）
  - 如果来的数据是迟到数据，但是所属窗口还在，那么数据可以进入窗口。
  - 如果来的数据是迟到数据，但所属窗口已经销毁，那么数据被{==丢弃==}。
- 将迟到数据发送到{==侧输出流==}中去。侧输出流是不同于主流输出的旁路输出流，可以向侧输出流发送任意数据。
  - `new OutputTag<T>("output-tag"){}`：单例

- 使用迟到元素{==更新==}窗口计算结果。也就是当 ProcessWindowFunction 的水位线到达窗口结束时间的时候，触发窗口计算，但不销毁窗口，而是选择再等待迟到元素一段时间。
  - `.allowedLateness(Time.seconds(5))`：窗口会等待 5 秒钟的迟到事件
  - 窗口真正销毁：ProcessWindowFunction 的水位线 >= 窗口结束时间 + allowedLateness
  - 窗口的第一次触发计算：水位线 >= 窗口结束时间，触发计算完以后窗口不会被销毁

处理迟到数据的作用：将迟到数据保存下来，然后统计一下每天有多少迟到数据，然后方便我们调整最大延迟时间的设置，改进计算结果的正确性。

