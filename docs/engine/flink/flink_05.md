# 第五章 窗口

## 窗口概念

!!! question 

    一般真实的流都是无界的，怎样处理无界的数据？

- 可以把无限的数据流进行切分，得到有限的数据集进行处理—也就是得到有界流。
- 窗口（ Window ）就是将无限流切割为有限流的一种方式，它会将流数据分发到有限大小的桶（ bucket ）中进行分析。

## 窗口的本质

> :memo: Flink 遵循了{==先分流再开窗==}的原则。

我们一般在 `.keyBy` 之后使用 `.window` 方法来进行开窗，实际上是在 keyBy 之后的逻辑分区中，再按照窗口进行一次逻辑分区。先分流再开窗。

```sql
SELECT count(*) FROM table GROUP BY key, window;
```

Flink 窗口是{==左闭右开==}的区间，例如 `[0, 5)` 的窗口最后一个时间戳是 `4999` 毫秒。

## 窗口类型

- 时间窗口（Time Window）
  - 滚动时间窗口
  - 滑动时间窗口
  - 会话时间窗口
- 计数窗口（Count Window）
  - 滚动计数窗口
  - 滑动计数窗口

## 滚动时间窗口

- 将数据依据固定的窗口长度对数据进行切分。
- 时间对齐，窗口长度固定，没有重叠。
- 10 秒钟的滚动处理时间窗口。`.window(TumblingProcessingTimeWindow.of(Time.seconds(10)))`。
- 公式：事件所属窗口的开始时间 = 事件的时间戳 - 事件的时间戳 % 滚动窗口大小
- 窗口是{==左闭右开==}。`[0, 10)`。最后一个时间戳是 `9999ms`

![28](https://cos.gump.cloud/uPic/28.svg)

- 滑动窗口是固定窗口的更广义的一种形式，滑动窗口由固定的窗口长度和滑动距离组成。

- `.window(SlidingProcessingTimeWindow.of(Time.seconds(10), Time.seconds(5)))`。

- 窗口长度固定，可以有重叠

- 如果一个元素同时属于两个窗口，那么会将元素复制两份，每个窗口分配一个元素。这样就可以保证{==所有的窗口从逻辑上分开处理==}。

!!! question

    如何计算一条数据属于哪个滑动窗口（窗口长度：10 秒钟，滑动距离：5 秒钟）呢？事件的时间戳是 7s，那么属于哪几个滑动窗口呢？

```
firstWindowStartTime = ts - ts % 滑动距离(5s)
starts = []
for (start = firstWindowStartTime; start > ts - 窗口长度(10s); start = start - 滑动距离(5s)) {
  starts.add(start)
}
starts => [5,0]
```

> :material-warning:潜在问题：如果窗口长度很长，滑动距离很短，那么一个元素会同时属于很多个窗口，会导致这个元素被复制很多次，从而对内存造成很大的压力。

```js
{
    "Mary": MapState {
        (0,10): [...,Event(7s)],
        (5,15): [...,Event(7s)],
        (10,20): [...],
        ...
        ...
    },
    "Bob": MapState {
        (0,10): [...,Event(7s)],
        (5,15): [...,Event(7s)],
        (10,20): [...],
        ...
        ...
    },
}
```

## 会话时间窗口

> :memo:会话窗口主要用来分析用户的会话，比如像刷抖音这种时长不固定的用户行为。

- 会话窗口的长度是{==不固定==}的。
- 使用超时时间（ `.withGap` ）来定义会话窗口。
- 会话窗口开始时间：窗口中第一个元素的时间戳
- 会话窗口结束时间：窗口中最后一个元素的时间戳 + 超时时间

![30](https://cos.gump.cloud/uPic/30.svg)
