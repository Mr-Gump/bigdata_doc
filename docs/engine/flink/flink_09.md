# 第九章 Flink的容错机制

- Flink程序如何从检查点恢复程序。（读）
- Flink如何保存检查点。（写）

## Flink程序如何从检查点恢复程序

![36](https://cos.gump.cloud/uPic/36.svg)

![37](https://cos.gump.cloud/uPic/37.svg)

![38](https://cos.gump.cloud/uPic/38.svg)

![39](https://cos.gump.cloud/uPic/39.svg)

无论重启多少次程序，某个数值只会在累加器中被累加一次，这个就叫做<span style="color:red">精准一次消费（Exactly-Once）</span>——既不会丢失数据，也不会重复累加某个数据。

## Flink如何保存检查点

**保存检查点的算法**

- 同步的思想（ Spark 采用）
  1. 暂停应用
  1. 保存状态到检查点文件
  1. 再重新恢复应用
- 异步的思想（ Flink 的改进实现）
  - 基于 Chandy-Lamport[^1]算法的异步分布式快照算法
  - 核心思想：将检查点的保存和数据处理分离开，不暂停整个应用

[^1]: Leslie Lamport： 分布式系统领域的上帝。发明了逻辑时钟。发明了 Paxos 算法。发明了$\LaTeX$​排版软件（科技文献排版标准）。图灵奖得主。微软首席科学家。

**算法的核心机制：检查点分界线**

> 检查点分界线：checkpoint barrier

- 检查点分界线是一种{==特殊的事件==}。用来把一条流上的数据按照不同的检查点分开。
- 检查点分界线之前到来的数据导致的状态更改，都会被包含在当前检查点分界线所属的检查点中；而基于检查点分界线之后的数据导致的所有更改，就会被包含在之后的检查点中。
- 检查点分界线到达哪一个并行子任务，就对哪一个并行子任务的状态做快照。和水位线类比：水位线到达哪一个并行子任务，就更改哪一个并行子任务的水位线。

> :memo:Flink中有两种特殊的事件：
>
> - 水位线（逻辑时钟）
> - 检查点分界线

![40](https://cos.gump.cloud/uPic/40.svg)

在分流时，检查点分界线是{==广播==}出去的。和水位线在分流时的传递机制相同。

![41](https://cos.gump.cloud/uPic/41.svg)

- 分界线对齐：检查点分界线向下游传递，sum 任务会等待所有输入分区的检查点分界线到达
- 对于检查点分界线已经到达的分区，继续到达的数据会被缓存（比如蓝色三角形 2 后面的 4）
- 而检查点分界线尚未到达的分区，数据会被正常处理（比如红色三角形 2 之前到达的数据）

sum_even 什么时候做快照？必须接收到来自 source1 和 source2 的所有检查点分界线时，才会做快照。这个机制叫做{==检查点分界线对齐==}。检查点分界线在合流时的传递机制和水位线不一样。

> 每一个并行子任务在做完快照以后，都会向作业管理器发送一条通知，然后将检查点分界线向下游传递。

![44](https://cos.gump.cloud/uPic/44.svg)


Sum 并行子任务将它们的状态写入检查点文件，Sum 的并行子任务会向作业管理器发送通知确认 Sum 的并行子任务的检查点保存完成。然后继续向下游发送检查点分界线。

![45](https://cos.gump.cloud/uPic/45.svg)

![46](https://cos.gump.cloud/uPic/46.svg)

{==此时，作业管理器接收到了所有的 6 个并行子任务发送过来的通知，那么就会确认本次检查点保存的完成。然后作业管理器会向所有的 6 个并行子任务发送一条检查点完成的广播通知==}。